        SELECT
        n.ip,
        n.cluster,
        n.hostname,
        n.power,
        n.cpu,
        n.cpu_num,
        n.cpu_slot_num,
        n.mem,
        n.system_type,
        n.system_version,
        n.net_num,
        n.product_name,
        n.product_serial,
        n.bios_version,

        COUNT(1) vmnum,
        SUM(CASE v.os_type WHEN 'linux' THEN 1 ELSE 0 END) vmlinuxnum,
        SUM(CASE v.os_type WHEN 'windows' THEN 1 ELSE 0 END) vmwindowsnum,
        SUM(to_number(v.vcpu_num, '99G999D9S')) vcputotal,
        SUM(to_number(v.memory, '99G999D9S')) memtotal,
        array_to_string(array_agg(v.volume_info), ',|') volumesinfo,
        SUM(to_number(v.net_num, '99G999D9S')) netnumtotal
        FROM ( select *,row_number() over(partition by cluster,hostname order by reportdate desc)as cnt from
        oms_node_${zq}
        where reportdate &gt;= '${starReportDate}' and reportdate &lt;='${endReportDate}'
        AND (power = '1' or agent_alive = '1')
        AND cluster = '${cluster}'
        and cloud_uuid = '${cloudUuid}'
        AND is_delete = 'false'
        ) n
        inner JOIN (select *,row_number() over(partition by cluster,uuid order by reportdate desc)as cnt from oms_vm_${zq}
        where reportdate &gt;= '${starReportDate}' and reportdate &lt;='${endReportDate}' AND power = 'RUNNING'
        ) v
        ON (n.cluster = v.cluster AND n.hostname = v.parenthostname)
        WHERE n.cnt=1 and v.cnt=1
        group by n.ip,
        n.cluster,
        n.hostname,
        n.power,
        n.cpu,
        n.cpu_num,
        n.cpu_slot_num,
        n.mem,
        n.system_type,
        n.system_version,
        n.net_num,
        n.product_name,
        n.product_serial,
        n.bios_version